ifeq (,$(filter true, $(TARGET_NO_KERNEL) $(TARGET_NO_RECOVERY)))

MKIMAGE := $(HOST_OUT_EXECUTABLES)/mkimage$(HOST_EXECUTABLE_SUFFIX)

INSTALLED_URAMDISK_RECOVERY_TARGET := $(PRODUCT_OUT)/uramdisk-recovery.img
INSTALLED_URAMDISK_RECOVERY_TARGET_SIGNED := $(PRODUCT_OUT)/uramdisk-recovery-signed.img

# 1KB blocks for mkfs.vfat
RECOVERYIMAGE_BLOCKS := $(shell expr $(BOARD_RECOVERYIMAGE_PARTITION_SIZE) / 1024)

# Recovery image included files
RECOVERYIMAGE_FILES := $(TARGET_PREBUILT_KERNEL_ZIMAGE)
RECOVERYIMAGE_FILES += $(shell echo $(TARGET_BOARD_DTS_CONFIG) | sed -e "s,[^: ]\+:,$(KERNEL_OUT)/,g")
RECOVERYIMAGE_FILES += $(INSTALLED_BOOTSCRIPT_TARGET)
RECOVERYIMAGE_FILES += $(INSTALLED_URAMDISK_RECOVERY_TARGET)

$(INSTALLED_RECOVERYIMAGE_TARGET): $(INSTALLED_BOOTSCRIPT_TARGET) $(wildcard $(LOCALCONF_MK)) | $(MKIMAGE) $(if $(TF_SIGN_ENABLED),$(TF_SIGN_ARTIFACT))
	# Build the recovery ramdisk
	$(call build-recoveryimage-target, $@)
	$(hide) $(MKIMAGE) -A arm -O linux -T ramdisk -n "Android U-Boot recovery ramdisk" -d $(recovery_ramdisk) $(INSTALLED_URAMDISK_RECOVERY_TARGET)
	$(hide) if [ "$$TF_SIGN_ENABLED" = "1" ]; then \
		$(TF_SIGN_ARTIFACT) -p ccimx6 -i $(INSTALLED_URAMDISK_RECOVERY_TARGET) $(INSTALLED_URAMDISK_RECOVERY_TARGET_SIGNED); \
		mv $(INSTALLED_URAMDISK_RECOVERY_TARGET_SIGNED) $(INSTALLED_URAMDISK_RECOVERY_TARGET); \
	fi
	$(call pretty,"Target DEA recovery image: $@")
	# Remove Android type recovery images (generated by build-recoveryimage-target)
	rm -f $(basename $@)*$(suffix $@) $@ && mkfs.vfat -s 1 -n "RECOVERY" -S 512 -C $@ $(RECOVERYIMAGE_BLOCKS)
	$(FAT16COPY) $@ $(RECOVERYIMAGE_FILES)
	#
	# Truncate VFAT recovery image:
	#   - size of files + 10% extra space (in bytes)
	#   - u-boot writes 512 bytes sectors so truncate at a sector boundary
	#
	RECOVERYIMAGE_FILES_SIZE="$$(($$(du -bc $(RECOVERYIMAGE_FILES) | tail -n1 | cut -f1) * (100 + 10) / 100))"; \
	truncate -s $$((((RECOVERYIMAGE_FILES_SIZE + 511) / 512) * 512)) $@

endif
